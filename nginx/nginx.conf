events {
  worker_connections 1024;
}

http {
  server {
    listen 8080;
    root /usr/share/nginx/html;
    
    location /auth {
      if ($request_method = OPTIONS) {
        return 204;
      }
      add_header Access-Control-Allow-Origin *;
      add_header Access-Control-Allow-Credentials true;
      add_header Access-Control-Allow-Methods GET,PUT,POST,DELETE,PATCH,OPTIONS;
      add_header Access-Control-Max-Age 3600;
      add_header Access-Control-Expose-Headers Content-Length;
      add_header Access-Control-Allow-Headers *;

      proxy_pass http://auth:8080/auth;
    }
    location /check {
      if ($request_method = OPTIONS) {
        return 204;
      }
      add_header Access-Control-Allow-Origin *;
      add_header Access-Control-Allow-Credentials true;
      add_header Access-Control-Allow-Methods GET,PUT,POST,DELETE,PATCH,OPTIONS;
      add_header Access-Control-Max-Age 3600;
      add_header Access-Control-Expose-Headers Content-Length;
      add_header Access-Control-Allow-Headers *;
      proxy_pass http://auth:8080/auth/check;

      proxy_pass_request_body off;
          proxy_set_header        Content-Length "";
          proxy_set_header        X-Original-URI $request_uri;

    }
    location /user {
      if ($request_method = OPTIONS) {
        return 204;
      }
      add_header Access-Control-Allow-Origin *;
      add_header Access-Control-Allow-Credentials true;
      add_header Access-Control-Allow-Methods GET,PUT,POST,DELETE,PATCH,OPTIONS;
      add_header Access-Control-Max-Age 3600;
      add_header Access-Control-Expose-Headers Content-Length;
      add_header Access-Control-Allow-Headers *;

      auth_request /check;
      auth_request_set $auth_status $upstream_status;
      proxy_pass http://user:8080/user;
    }
    location /restaurants {
      if ($request_method = OPTIONS) {
        return 204;
      }
      add_header Access-Control-Allow-Origin *;
      add_header Access-Control-Allow-Credentials true;
      add_header Access-Control-Allow-Methods GET,PUT,POST,DELETE,PATCH,OPTIONS;
      add_header Access-Control-Max-Age 3600;
      add_header Access-Control-Expose-Headers Content-Length;
      add_header Access-Control-Allow-Headers *;

      auth_request /check;
      auth_request_set $auth_status $upstream_status;
      proxy_pass http://restaurants:8080/restaurants;
    }
    location /catalogs {
      if ($request_method = OPTIONS) {
        return 204;
      }
      add_header Access-Control-Allow-Origin *;
      add_header Access-Control-Allow-Credentials true;
      add_header Access-Control-Allow-Methods GET,PUT,POST,DELETE,PATCH,OPTIONS;
      add_header Access-Control-Max-Age 3600;
      add_header Access-Control-Expose-Headers Content-Length;
      add_header Access-Control-Allow-Headers *;

      auth_request /check;
      auth_request_set $auth_status $upstream_status;
      proxy_pass http://catalogs:8080/catalogs;
    }
    location /notifications {
      if ($request_method = OPTIONS) {
        return 204;
      }
      add_header Access-Control-Allow-Origin *;
      add_header Access-Control-Allow-Credentials true;
      add_header Access-Control-Allow-Methods GET,PUT,POST,DELETE,PATCH,OPTIONS;
      add_header Access-Control-Max-Age 3600;
      add_header Access-Control-Expose-Headers Content-Length;
      add_header Access-Control-Allow-Headers *;

      auth_request /check;
      auth_request_set $auth_status $upstream_status;
      proxy_pass http://notifications:8080/notifications;
    }
    location /commands {
      if ($request_method = OPTIONS) {
        return 204;
      }
      add_header Access-Control-Allow-Origin *;
      add_header Access-Control-Allow-Credentials true;
      add_header Access-Control-Allow-Methods GET,PUT,POST,DELETE,PATCH,OPTIONS;
      add_header Access-Control-Max-Age 3600;
      add_header Access-Control-Expose-Headers Content-Length;
      add_header Access-Control-Allow-Headers *;

      auth_request /check;
      auth_request_set $auth_status $upstream_status;
      proxy_pass http://commands:8080/commands;
    }
    location /livraisons {
      if ($request_method = OPTIONS) {
        return 204;
      }
      add_header Access-Control-Allow-Origin *;
      add_header Access-Control-Allow-Credentials true;
      add_header Access-Control-Allow-Methods GET,PUT,POST,DELETE,PATCH,OPTIONS;
      add_header Access-Control-Max-Age 3600;
      add_header Access-Control-Expose-Headers Content-Length;
      add_header Access-Control-Allow-Headers *;

      auth_request /check;
      auth_request_set $auth_status $upstream_status;
      proxy_pass http://livraisons:8080/livraisons;
    }
  }
}